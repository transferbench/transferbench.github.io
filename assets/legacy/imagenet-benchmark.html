<!--
<div class="row">
    <div class="mt-2 col-md-12">
    <p>
        For ImageNet, we evaluate transferability across 8 victim models starting from three different surrogate pools. 
        In the <code>HeteroPool</code> setting, we include: 
        The <code>HomeoPool</code> setting :
        Finally, the <code>RobustPool</code> setting includes robust victim models :
    </p>
    </div>
</div>
-->

<!-- HTML for ImageNet -->
<div class="row">
    <div class="col-md-6 col-6">
        <div class="dropdown">
            <button
                class="btn btn-secondary dropdown-toggle"
                type="button" id="dropdownModelImageNet"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
            >
                Victim model
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownModelImageNet" id="victim-list-imagenet"></div>
        </div>
    </div>

    <div class="col-md-6 col-6">
        <div class="dropdown">
            <button
                class="btn btn-secondary dropdown-toggle"
                type="button" id="dropdownAttackImageNet"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
            >
                Surrogate pool
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownAttackImageNet" id="surrogate-list-imagenet"></div>
        </div>
    </div>
</div>

<div class="tg-wrap">
    <table class="tg" style="width: 100%;">
        <thead>
            <tr style="border-bottom: 1px solid black;">
                <th class="tg-tb-center">Attack</th>
                <th class="tg-tb-center" id="ASR">
                    ASR (%) <span class="filter-symbol-imagenet">&#x25B2;</span>
                </th>
                <th class="tg-tb-center" id="queries">
                    #Queries <span class="filter-symbol-imagenet">&#x25B2;</span>
                </th>
            </tr>
        </thead>
        <tbody class="benchmark-imagenet"></tbody>
    </table>
</div>

<nav aria-label="Table Pagination" class="mt-2">
    <ul class="pagination pagination-imagenet justify-content-end"></ul>
</nav>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            processEscapes: true
        }
    });
</script>
<script
    type="text/javascript"
    async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
></script>

<script>
$(function() {
    // MathJax helper
    function renderMathJax() {
        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }

    // State
    let fullData;
    let victim_selector = null;
    let surrogate_selector = null;

    // Table config
    const sortable = { ASR: false, queries: false };
    const page_size = 15;
    let current_page = 1;
    let total_pages = 1;
    let tableData = [];

    // Fetch once
    $.getJSON('assets/data.json', data => {
        fullData = data.ImageNet;
        populateVictimDropdown();
        // default to first victim & its first surrogate
        victim_selector = Object.keys(fullData)[0];
        surrogate_selector = Object.keys(fullData[victim_selector])[0];
        updateDropdownButtonText($('#dropdownModelImageNet'), `Victim model: ${victim_selector}`);
        load_data();  // Load data for the selected victim and surrogate
    });

    // Populate victim dropdown
    function populateVictimDropdown() {
        const menu = $('#victim-list-imagenet').empty();
        Object.keys(fullData).forEach(model => {
            $('<button>')
                .addClass('dropdown-item')
                .attr('type','button')
                .data('model', model)
                .text(model)
                .appendTo(menu);
        });
    }

    // Populate surrogate dropdown for current victim
    function populateSurrogateDropdown() {
        const menu = $('#surrogate-list-imagenet').empty();
        Object.keys(fullData[victim_selector]).forEach(pool => {
            $('<button>')
                .addClass('dropdown-item')
                .attr('type','button')
                .data('attack', pool)
                .text(pool)
                .appendTo(menu);
        });
    }

    // Load & render table
    function load_data() {
        tableData = fullData[victim_selector][surrogate_selector];
        total_pages = Math.ceil(tableData.length / page_size);
        sortTable('ASR');
        populateTable();
        renderPagination();
        renderMathJax();
        populateSurrogateDropdown();
        populateVictimDropdown();
    }

    // Table population
    function populateTable() {
        const start = (current_page-1)*page_size;
        const slice = tableData.slice(start, start+page_size);
        const $tbody = $('.benchmark-imagenet').empty();
        let alt = false;
        slice.forEach(item => {
            const $tr = $('<tr>');
            $tr.append($('<td>').addClass(alt?'tg-30first atkname':'tg-30second atkname').text(item.attack_name));
            $tr.append($('<td>').addClass(alt?'tg-44first':'tg-44second').text(parseFloat(item.ASR.toPrecision(5))));
            $tr.append($('<td>').addClass(alt?'tg-44first':'tg-44second').text(item.queries));
            $tbody.append($tr);
            alt = !alt;
        });
        renderMathJax();
    }

    // Pagination
    function renderPagination() {
        const $ul = $('.pagination-imagenet').empty();
        for (let i=1; i<=total_pages; i++) {
            const $li = $('<li>').addClass('page-item' + (i===current_page?' active':''));
            $('<a>').addClass('page-link').attr('href','#').text(i).appendTo($li);
            $ul.append($li);
        }
    }

    // Sorting
    function sortTable(col) {
        tableData.sort((a,b) => {
            let A = col==='queries'
                ? ((a.n_forwards||0)+(a.n_backwards||0))
                : parseFloat(a[col]);
            let B = col==='queries'
                ? ((b.n_forwards||0)+(b.n_backwards||0))
                : parseFloat(b[col]);
            return sortable[col] ? A-B : B-A;
        });
    }

    // Update button text
    function updateDropdownButtonText($btn, txt) {
        $btn.text(txt);
    }

    // Delegated event handlers:

    // Victim model selection
    $(document).on('click', '#victim-list-imagenet .dropdown-item', function(e) {
        e.preventDefault();
        victim_selector = $(this).data('model');
        updateDropdownButtonText($('#dropdownModelImageNet'), `Victim model: ${victim_selector}`);
        // reset surrogate to first of new victim
        surrogate_selector = Object.keys(fullData[victim_selector])[0];
        updateDropdownButtonText($('#dropdownAttackImageNet'), `Surrogate pool: ${surrogate_selector}`);
        current_page = 1;
        load_data();
    });

    // Surrogate pool selection
    $(document).on('click', '#surrogate-list-imagenet .dropdown-item', function(e) {
        e.preventDefault();
        surrogate_selector = $(this).data('attack');
        updateDropdownButtonText($('#dropdownAttackImageNet'), `Surrogate pool: ${surrogate_selector}`);
        current_page = 1;
        load_data();
    });

    // Pagination click
    $(document).on('click', '.pagination-imagenet .page-link', function(e) {
        e.preventDefault();
        current_page = +$(this).text();
        populateTable();
        renderPagination();
    });

    // Column header sort
    $(document).on('click', '.tg-tb-center', function() {
        const col = $(this).attr('id');
        if (!sortable.hasOwnProperty(col)) return;
        sortable[col] = !sortable[col];
        sortTable(col);
        populateTable();
        renderPagination();
        $(this).find('.filter-symbol-imagenet').html(sortable[col]?'&#x25BC;':'&#x25B2;');
    });

});
</script>
